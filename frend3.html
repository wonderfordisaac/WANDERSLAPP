<!DOCTYPE html>
<html lang="ny">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WanderSlapp - Friends</title>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
    <style>
        :root { --navy: #0a142b; --blue: #254a83; --gray: #f0f2f5; }
        body { font-family: sans-serif; background: var(--gray); margin: 0; padding: 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: var(--navy); font-weight: bold; }
        
        /* Kakang'ono kaku left */
        .btn-toggle { 
            background: var(--navy); color: white; border: none; 
            padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; 
        }

        .section { margin-bottom: 25px; }
        h2 { font-size: 16px; color: var(--navy); border-left: 4px solid var(--blue); padding-left: 10px; }

        .user-card { 
            display: flex; align-items: center; background: white; padding: 12px; 
            margin-bottom: 10px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        }
        .user-info { display: flex; align-items: center; flex-grow: 1; }
        .user-info img { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background: #ddd; }
        .user-info b { font-size: 14px; color: #333; }
        
        button.action { 
            padding: 7px 12px; border-radius: 6px; border: none; 
            font-size: 11px; font-weight: bold; cursor: pointer; 
        }
        .btn-add { background: var(--blue); color: white; }
        .btn-pending { background: #ccc; color: #666; cursor: default; }
        .btn-confirm { background: #28a745; color: white; }
        .btn-unfriend { background: #fce8e8; color: #d93025; }

        #friendsSection { display: none; background: #e2e8f0; padding: 10px; border-radius: 12px; margin-bottom: 20px; }
        .error-msg { color: red; font-size: 12px; background: #ffdada; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <a href="dashboad.html" class="back-btn">← Back</a>
        <button class="btn-toggle" onclick="toggleFriends()">Your Friends</button>
    </div>

    <div id="friendsSection">
        <h2>Anzanu (Confirmed)</h2>
        <div id="friendsList"></div>
    </div>

    <div class="section">
        <h2>Friend Requests</h2>
        <div id="requestsList"></div>
    </div>

    <div class="section">
        <h2>People You May Know</h2>
        <div id="errorDisplay"></div>
        <div id="suggestedUsers">Kutsegula anthu...</div>
    </div>

<script>
    // ✅ Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyBBZxCwywnv_ZVXYezOV8IKG6iKWK5sL10",
        authDomain: "studio-ywlo1.firebaseapp.com",
        projectId: "studio-ywlo1",
        storageBucket: "studio-ywlo1.appspot.com",
        messagingSenderId: "791958850921",
        appId: "1:791958850921:web:149be668e7f132e59f41f8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let myID = null;
    let myName = "";

    function toggleFriends() {
        const x = document.getElementById("friendsSection");
        x.style.display = (x.style.display === "block") ? "none" : "block";
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            myID = user.uid;
            // Pezani dzina langa poyamba
            db.collection("users").doc(myID).get().then(doc => {
                if(doc.exists) myName = doc.data().fullName || "User";
                loadAll();
            });
        } else {
            window.location.href = "index.html";
        }
    });

    async function loadAll() {
        try {
            // 1. Pezani ma requests onse amene ndili nawo
            // Timagwiritsa ntchito "onSnapshot" kuti zizisintha zokha
            db.collection("friendRequests").onSnapshot(async (snapshot) => {
                let involved = {}; // Ma ID a anthu amene tili nawo kale mu chibale
                
                const reqDiv = document.getElementById("requestsList");
                const friendDiv = document.getElementById("friendsList");
                reqDiv.innerHTML = "";
                friendDiv.innerHTML = "";

                snapshot.forEach(doc => {
                    const d = doc.data();
                    const docID = doc.id;

                    // Sungani ma ID onse mu list
                    if(d.from === myID) involved[d.to] = d.status;
                    if(d.to === myID) involved[d.from] = d.status;

                    // Ngati ndalandira request (Pending)
                    if(d.to === myID && d.status === "pending") {
                        fetchUserAndRender(d.from, reqDiv, `<button class="action btn-confirm" onclick="confirmFriend('${docID}', '${d.from}')">Confirm</button>`);
                    }

                    // Ngati tili pa ubwenzi (Confirmed)
                    if(d.status === "confirmed") {
                        let friendID = (d.from === myID) ? d.to : d.from;
                        fetchUserAndRender(friendID, friendDiv, `<button class="action btn-unfriend" onclick="removeReq('${docID}')">Unfriend</button>`);
                    }
                });

                // 2. Pezani Users onse (People You May Know)
                loadSuggested(involved);
            });
        } catch (err) {
            document.getElementById("errorDisplay").innerHTML = `<div class="error-msg">Vuto: ${err.message}</div>`;
        }
    }

    function loadSuggested(involved) {
        db.collection("users").get().then(snap => {
            const container = document.getElementById("suggestedUsers");
            container.innerHTML = "";
            
            snap.forEach(doc => {
                const u = doc.data();
                const uID = doc.id;

                // Usadzionetse wekha komanso usawaonetse anzako kale
                if(uID !== myID && !involved[uID]) {
                    container.innerHTML += `
                        <div class="user-card">
                            <div class="user-info">
                                <img src="${u.profilePhoto || 'https://i.ibb.co/7z5nDqK/avatar.png'}">
                                <b>${u.fullName || 'User'}</b>
                            </div>
                            <button class="action btn-add" onclick="sendReq('${uID}', '${u.fullName}')">Add Friend</button>
                        </div>`;
                } else if (involved[uID] === "pending" && involved[uID] !== "confirmed") {
                    // Ngati watumiza kale koma sanavomereze
                    // (Izi zioneka ngati mukufuna)
                }
            });
            if(container.innerHTML === "") container.innerHTML = "<small>Palibe anthu ena.</small>";
        });
    }

    function fetchUserAndRender(uid, container, btns) {
        db.collection("users").doc(uid).get().then(doc => {
            const u = doc.data();
            if(u) {
                container.innerHTML += `
                    <div class="user-card">
                        <div class="user-info">
                            <img src="${u.profilePhoto || 'https://i.ibb.co/7z5nDqK/avatar.png'}">
                            <b>${u.fullName}</b>
                        </div>
                        <div class="btns">${btns}</div>
                    </div>`;
            }
        });
    }

    function sendReq(toID, toName) {
        db.collection("friendRequests").add({
            from: myID, to: toID, status: "pending", timestamp: Date.now()
        }).then(() => {
            db.collection("notifications").add({
                to: toID, message: `${myName} wakutumizirani friend request.`, 
                timestamp: Date.now(), read: false
            });
            alert("Request yatumizidwa!");
        });
    }

    function confirmFriend(docID, fromID) {
        db.collection("friendRequests").doc(docID).update({ status: "confirmed" }).then(() => {
            db.collection("notifications").add({
                to: fromID, message: `${myName} wavomereza friend request yanu!`, 
                timestamp: Date.now(), read: false
            });
        });
    }

    function removeReq(id) {
        if(confirm("Are you sure?")) db.collection("friendRequests").doc(id).delete();
    }
</script>
</body>
</html>